!function(e,t,o,n){"use strict";e.fn.EVFBackboneModal=function(t){return this.each(function(){new e.EVFBackboneModal(e(this),t)})},e.EVFBackboneModal=function(t,o){var n=e.extend({},e.EVFBackboneModal.defaultOptions,o);n.template&&new e.EVFBackboneModal.View({target:n.template,string:n.variable})},e.EVFBackboneModal.defaultOptions={template:"",variable:{}},e.EVFBackboneModal.View=t.View.extend({tagName:"div",id:"evf-backbone-modal-dialog",_target:undefined,_string:undefined,events:{"click .modal-close":"closeButton","click #btn-ok":"addButton","touchstart #btn-ok":"addButton",keydown:"keyboardActions"},resizeContent:function(){var t=e(".evf-backbone-modal-content").find("article"),o=.75*e(window).height();t.css({"max-height":o+"px"})},initialize:function(t){var n=this;this._target=t.target,this._string=t.string,o.bindAll(this,"render"),this.render(),e(window).resize(function(){n.resizeContent()})},render:function(){var t=wp.template(this._target);this.$el.append(t(this._string)),e(document.body).css({overflow:"hidden"}).append(this.$el),this.resizeContent(),this.$(".evf-backbone-modal-content").attr("tabindex","0").focus(),e(document.body).trigger("init_tooltips"),e(document.body).trigger("evf_backbone_modal_loaded",this._target)},closeButton:function(t){t.preventDefault(),e(document.body).trigger("evf_backbone_modal_before_remove",this._target),this.undelegateEvents(),e(document).off("focusin"),e(document.body).css({overflow:"auto"}),this.remove(),e(document.body).trigger("evf_backbone_modal_removed",this._target)},addButton:function(t){e(document.body).trigger("evf_backbone_modal_response",[this._target,this.getFormData()]);var o={action:"everest_forms_new_form",security:n.evf_new_form_nonce,form_name:e("#evf-modal-form-name").val()};e.ajax({url:n.ajax_url,data:o,type:"POST",beforeSend:function(){},success:function(t){var o="",n="success";"undefined"!=typeof t.success?t.data.id>0?(o="Form successfully created. Redirecting....",setTimeout(function(){window.location=t.data.redirect},1e3)):(o="Unknown error ! Could not create a form",n="error"):(n="error",o="Unknown error ! Could not create a form");var a='<div id="message" class="notice notice-'+n+' is-dismissible"><p>'+o+"</p></div>";e("#evf-backbone-modal-dialog").find("#message").remove(),e("#evf-backbone-modal-dialog").find("article").append(a)}})},getFormData:function(){var t={};return e(document.body).trigger("evf_backbone_modal_before_update",this._target),e.each(e("form",this.$el).serializeArray(),function(o,n){-1!==n.name.indexOf("[]")?(n.name=n.name.replace("[]",""),t[n.name]=e.makeArray(t[n.name]),t[n.name].push(n.value)):t[n.name]=n.value}),t},keyboardActions:function(e){var t=e.keyCode||e.which;13!==t||e.target.tagName&&("input"===e.target.tagName.toLowerCase()||"textarea"===e.target.tagName.toLowerCase())||this.addButton(e),27===t&&this.closeButton(e)}}),e("body").on("click",".evf-add-new",function(t){return e(this).EVFBackboneModal({template:"evf-add-new-form",variable:{test:"tet"}}),!1})}(jQuery,Backbone,_,window.evf_form_modal_data);